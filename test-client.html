<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CS Chat Test - Mirip WhatsApp Web</title>

  <style>
    :root{
      --accent:#075e54;
      --bg:#e5ddd5;
      --bubble-sent:#dcf8c6;
      --bubble-recv:#ffffff;
      --muted:#667781;
      --delivered:#53bdeb;
      --read:#4fc3f7;
      --input-height:68px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
      margin:0;
      display:flex;
      flex-direction:column;
      height:100vh;
      background:var(--bg);
      -webkit-font-smoothing:antialiased;
    }

    header{
      background:var(--accent);
      color:#fff;
      padding:10px 14px;
      display:flex;
      gap:12px;
      align-items:center;
      box-shadow:0 1px 0 rgba(0,0,0,0.06);
    }
    .avatar{
      width:44px;height:44px;border-radius:50%;
      background:rgba(255,255,255,0.12);
      display:flex;align-items:center;justify-content:center;
      font-weight:700;font-size:18px;color:#fff;
    }
    .header-info{display:flex;flex-direction:column}
    .header-title{font-weight:700;font-size:16px}
    .header-status{font-size:13px;opacity:0.95;color:#e6f6f2;margin-top:2px}

    .chat-container{
      flex:1;
      overflow-y:auto;
      padding:18px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
      background-image:url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
      background-repeat:repeat;
      background-size:100%;
      padding-bottom:calc(var(--input-height) + 20px);
      scroll-behavior:smooth;
    }

    #typingStatus{
      font-size:13px;color:#333;padding:6px 10px;
      background:rgba(255,255,255,0.9);border-radius:10px;align-self:center;
      margin-bottom:6px;min-height:20px;display:inline-block;
      box-shadow:0 1px 1px rgba(0,0,0,0.04);
    }

    .message{
      max-width:78%;padding:10px 12px;border-radius:12px;position:relative;
      word-wrap:break-word;font-size:14.2px;line-height:19px;display:inline-block;
      box-shadow:0 1px 0 rgba(0,0,0,0.04);
    }
    .sent{background:var(--bubble-sent);align-self:flex-end;margin-left:auto;border-bottom-right-radius:4px}
    .received{background:var(--bubble-recv);align-self:flex-start;margin-right:auto;border-bottom-left-radius:4px}

    .meta{display:flex;gap:6px;align-items:center;justify-content:flex-end;margin-top:8px;font-size:11px;color:var(--muted)}
    .meta .time{opacity:0.95}
    .tick{display:inline-flex;align-items:center;justify-content:center;min-width:18px;margin-left:6px;font-size:12px;line-height:1}
    .tick-sent{color:var(--muted)}
    .tick-delivered{color:var(--delivered)}
    .tick-read{color:var(--read)}

    .input-area{
      position:fixed;left:0;right:0;bottom:0;height:var(--input-height);
      background:rgba(255,255,255,0.98);padding:10px;display:flex;align-items:center;gap:8px;
      border-top:1px solid #e6e6e6;box-shadow:0 -6px 18px rgba(0,0,0,0.04);
    }
    .input-area .fields{display:flex;gap:8px;align-items:center;flex:1}
    input[type="text"], input#chatId{
      height:44px;padding:10px 14px;border-radius:22px;border:1px solid #ddd;outline:none;font-size:15px;background:#fff;width: 100%;
    }
    button{
      background:var(--accent);color:#fff;border:none;padding:10px 16px;border-radius:22px;cursor:pointer;font-weight:700;height:44px;min-width:84px;
      display:inline-flex;align-items:center;justify-content:center;box-shadow:0 3px 8px rgba(7,94,84,0.16);
    }

    @media(max-width:600px){
      .message{max-width:86%}
      .avatar{width:40px;height:40px;font-size:16px}
      input[type="text"],input#chatId{height:40px}
    }
  </style>
</head>
<body>

  <header>
    <div class="avatar">CS</div>
    <div class="header-info">
      <div class="header-title">Customer Service Test</div>
      <div class="header-status" id="presenceStatus">Menunggu status...</div>
    </div>
  </header>

  <div class="chat-container" id="chatContainer">
    <div id="typingStatus"></div>
    <!-- pesan akan ditambahkan di sini -->
  </div>

  <div class="input-area">
    <div class="fields">
      <input id="chatId" type="text" placeholder="Chat ID (628xxx@s.whatsapp.net)" value="6289617349913@s.whatsapp.net" />
      <input id="text" type="text" placeholder="Ketik pesan..." autocomplete="off" />
    </div>
    <button id="sendBtn">Kirim</button>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const socket = io('http://localhost:3000', {
      path: '/socket.io/',
      transports: ['polling','websocket'],
      reconnection: true,
      timeout: 10000
    });

    const chatContainer = document.getElementById('chatContainer');
    const typingStatus = document.getElementById('typingStatus');
    const presenceStatus = document.getElementById('presenceStatus');
    const textInput = document.getElementById('text');
    const chatIdInput = document.getElementById('chatId');
    const sendBtn = document.getElementById('sendBtn');

    // Tracking yang lebih ketat
    const displayedMessageIds = new Set();  // REAL message IDs yang sudah ditampilkan
    const pendingTempIds = new Map();       // tempId -> { promise, resolve, reject }

    function log(...args){ console.debug('[client]', ...args) }

    textInput.focus();

    textInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); kirimPesan(); }
    });
    sendBtn.addEventListener('click', kirimPesan);

    socket.on('connect', () => {
      presenceStatus.innerHTML = 'Terhubung ke server';
      log('connected', socket.id);
    });

    socket.on('connect_error', (err) => {
      presenceStatus.innerHTML = 'Gagal terhubung: ' + (err?.message || err);
      console.error('connect_error', err);
    });

        socket.on('messageAck', (data) => {
      log('ðŸ“¨ messageAck EVENT DITERIMA:', data);
      const { tempId, message } = data || {};
      
      if (!tempId || !message || !message.id) {
        log('âš ï¸  messageAck: data incomplete, return');
        return;
      }

      log(`ðŸ” Cari temp bubble dengan selector: [data-id="${tempId}"]`);
      const tempBubble = document.querySelector(`[data-id="${tempId}"]`);
      log(`   Bubble ditemukan:`, !!tempBubble);
      
      if (tempBubble) {
        log(`âœ… Update data-id dari ${tempId} â†’ ${message.id}`);
        tempBubble.setAttribute('data-id', message.id);
        
        // Update UI (time & status)
        const wrapper = tempBubble.parentElement;
        const meta = wrapper.querySelector('.meta');
        if (meta) {
          const timeEl = meta.querySelector('.time');
          if (timeEl) {
            const newTime = new Date(message.timestamp).toLocaleTimeString('id-ID', {
              hour: '2-digit',
              minute: '2-digit'
            });
            log(`   Update time: ${timeEl.innerText} â†’ ${newTime}`);
            timeEl.innerText = newTime;
          }

          const tickEl = meta.querySelector('.tick');
          if (tickEl) {
            const oldTick = tickEl.innerText;
            if (message.status === 'delivered') {
              tickEl.innerText = 'âœ“âœ“';
              tickEl.className = 'tick tick-delivered';
            } else if (message.status === 'read') {
              tickEl.innerText = 'âœ“âœ“';
              tickEl.className = 'tick tick-read';
            } else {
              tickEl.innerText = 'âœ“';
              tickEl.className = 'tick tick-sent';
            }
            log(`   Update tick: ${oldTick} â†’ ${tickEl.innerText}`);
          }
        }

        displayedMessageIds.add(message.id);
        log(`âœ… Ditambah ke displayedMessageIds: ${message.id}`);
        log(`   displayedMessageIds sekarang:`, Array.from(displayedMessageIds));
      } else {
        log(`âŒ Temp bubble TIDAK DITEMUKAN untuk tempId: ${tempId}`);
        log(`   âš ï¸  FALLBACK: tambah pesan baru (ini yang menyebabkan duplikat!)`);
        tambahPesanKeUI(message);
        displayedMessageIds.add(message.id);
      }
    });
    
    // Incoming message
    socket.on('newMessage', (msg) => {
      log('ðŸ“© newMessage EVENT DITERIMA:', msg);
      if (!msg || !msg.id) {
        log('âš ï¸  newMessage: msg incomplete, return');
        return;
      }

      log(`ðŸ” Check if ${msg.id} sudah ditampilkan...`);
      log(`   displayedMessageIds:`, Array.from(displayedMessageIds));
      
      if (displayedMessageIds.has(msg.id)) {
        log(`âœ… ${msg.id} SUDAH ditampilkan, hanya update status`);
        updateStatusBubble(msg.id, msg.status);
        return;
      }

      log(`âŒ ${msg.id} BELUM ditampilkan, tambahkan ke UI`);
      tambahPesanKeUI(msg);  // âœ… UNCOMMENT ini
      displayedMessageIds.add(msg.id);
      scrollKeBawah();
    });
    // Incoming message (dari customer atau broadcast dari server)
    socket.on('newMessage', (msg) => {
      log('newMessage', msg);
      if (!msg || !msg.id) return;

      // JANGAN tambah kalau real ID sudah ditampilkan
      if (displayedMessageIds.has(msg.id)) {
        log(`newMessage: skip karena ${msg.id} sudah ditampilkan`);
        updateStatusBubble(msg.id, msg.status);
        return;
      }

      log(`newMessage: adding ${msg.id} ke UI`);
      tambahPesanKeUI(msg);
      displayedMessageIds.add(msg.id);
      scrollKeBawah();
    });

    socket.on('typing', (data) => {
      typingStatus.innerHTML = data?.isTyping ? 'Sedang mengetik...' : '';
      if (data?.isTyping){
        clearTimeout(window._typingTimeout);
        window._typingTimeout = setTimeout(() => {
          typingStatus.innerHTML = '';
        }, 3500);
      }
    });

    socket.on('presence', (data) => {
      let text = data?.isOnline ? 'Online' : 'Offline';
      if (!data?.isOnline && data?.lastSeen) {
        text += ` â€¢ Terakhir dilihat: ${new Date(data.lastSeen).toLocaleString('id-ID')}`;
      }
      presenceStatus.innerHTML = text;
    });

    socket.on('receipt', (data) => {
      log('receipt', data);
      if (!data?.messageId) return;
      updateStatusBubble(data.messageId, data.status);
    });

        function kirimPesan(){
      const chatId = chatIdInput.value.trim();
      const text = textInput.value.trim();
      if (!chatId || !text) return alert('Isi chatId dan pesan!');

      const tempId = 'temp-' + Date.now() + '-' + Math.floor(Math.random()*9999);
      
      log(`ðŸš€ kirimPesan: emit sendMessage dengan tempId=${tempId}`);
      socket.emit('sendMessage', { chatId, text, tempId });

      // Tampilkan optimistic bubble
      log(`ðŸ“ Tambah optimistic bubble dengan tempId=${tempId}`);
      tambahPesanKeUI({
        id: tempId,
        chatId,
        from: 'agent',
        text,
        status: 'sent',
        timestamp: new Date().toISOString()
      });
      
      log(`âœ… displayedMessageIds SEBELUM ack:`, Array.from(displayedMessageIds));

      textInput.value = '';
      textInput.focus();
      scrollKeBawah();
    }

    function tambahPesanKeUI(msg){
      const isSent = msg.from === 'agent';
      const wrapper = document.createElement('div');
      wrapper.style.display = 'flex';
      wrapper.style.flexDirection = 'column';
      wrapper.style.alignItems = isSent ? 'flex-end' : 'flex-start';

      const bubble = document.createElement('div');
      bubble.className = `message ${isSent ? 'sent' : 'received'}`;
      bubble.setAttribute('data-id', msg.id);
      bubble.innerText = msg.text || '[Pesan lain]';

      const meta = document.createElement('div');
      meta.className = 'meta';
      const time = document.createElement('div');
      time.className = 'time';
      const ts = msg.timestamp ? new Date(msg.timestamp) : new Date();
      time.innerText = ts.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
      meta.appendChild(time);

      if (isSent){
        const tick = document.createElement('div');
        tick.className = 'tick tick-sent';
        if (msg.status === 'sent') { 
          tick.innerText = 'âœ“'; 
          tick.className = 'tick tick-sent';
        } else if (msg.status === 'delivered') { 
          tick.innerText = 'âœ“âœ“'; 
          tick.className = 'tick tick-delivered';
        } else if (msg.status === 'read') { 
          tick.innerText = 'âœ“âœ“'; 
          tick.className = 'tick tick-read';
        }
        meta.appendChild(tick);
      }

      wrapper.appendChild(bubble);
      wrapper.appendChild(meta);
      chatContainer.appendChild(wrapper);
    }

    function updateStatusBubble(messageId, status){
      const bubble = document.querySelector(`[data-id="${messageId}"]`);
      if (!bubble) {
        log(`updateStatusBubble: bubble ${messageId} tidak ditemukan`);
        return;
      }
      updateMetaForBubble(bubble, status);
    }

    function updateMetaForBubble(bubble, status){
      const meta = bubble.parentElement.querySelector('.meta');
      if (!meta) return;
      const tickEl = meta.querySelector('.tick');
      if (!tickEl) return;
      if (status === 'delivered') { 
        tickEl.innerText = 'âœ“âœ“'; 
        tickEl.className = 'tick tick-delivered';
      } else if (status === 'read') { 
        tickEl.innerText = 'âœ“âœ“'; 
        tickEl.className = 'tick tick-read';
      } else { 
        tickEl.innerText = 'âœ“'; 
        tickEl.className = 'tick tick-sent';
      }
    }

    function scrollKeBawah(){ 
      chatContainer.scrollTop = chatContainer.scrollHeight; 
    }

    window.addEventListener('resize', ()=>{ 
      setTimeout(scrollKeBawah, 100); 
    });

    ['connect','disconnect','reconnect','reconnect_attempt'].forEach(e=>{
      socket.on(e,(...a)=>log('socket event',e,...a));
    });

  </script>
</body>
</html>