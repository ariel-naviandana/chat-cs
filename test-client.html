<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CS Chat Test - Mirip WhatsApp Web</title>

  <style>
    :root{
      --accent:#075e54;
      --bg:#e5ddd5;
      --bubble-sent:#dcf8c6;
      --bubble-recv:#ffffff;
      --muted:#667781;
      --delivered:#53bdeb;
      --read:#4fc3f7;
      --input-height:68px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
      margin:0;
      display:flex;
      flex-direction:column;
      height:100vh;
      background:var(--bg);
      -webkit-font-smoothing:antialiased;
    }

    header{
      background:var(--accent);
      color:#fff;
      padding:10px 14px;
      display:flex;
      gap:12px;
      align-items:center;
      box-shadow:0 1px 0 rgba(0,0,0,0.06);
    }
    .avatar{
      width:44px;height:44px;border-radius:50%;
      background:rgba(255,255,255,0.12);
      display:flex;align-items:center;justify-content:center;
      font-weight:700;font-size:18px;color:#fff;
    }
    .header-info{display:flex;flex-direction:column}
    .header-title{font-weight:700;font-size:16px}
    .header-status{font-size:13px;opacity:0.95;color:#e6f6f2;margin-top:2px}

    .chat-container{
      flex:1;
      overflow-y:auto;
      padding:18px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
      background-image:url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
      background-repeat:repeat;
      background-size:100%;
      padding-bottom:calc(var(--input-height) + 20px);
      scroll-behavior:smooth;
    }

    #typingStatus{
      font-size:13px;color:#333;padding:6px 10px;
      background:rgba(255,255,255,0.9);border-radius:10px;align-self:center;
      margin-bottom:6px;min-height:20px;display:inline-block;
      box-shadow:0 1px 1px rgba(0,0,0,0.04);
    }

    .message{
      max-width:78%;padding:10px 12px;border-radius:12px;position:relative;
      word-wrap:break-word;font-size:14.2px;line-height:19px;display:inline-block;
      box-shadow:0 1px 0 rgba(0,0,0,0.04);
    }
    .sent{background:var(--bubble-sent);align-self:flex-end;margin-left:auto;border-bottom-right-radius:4px}
    .received{background:var(--bubble-recv);align-self:flex-start;margin-right:auto;border-bottom-left-radius:4px}

    .meta{display:flex;gap:6px;align-items:center;justify-content:flex-end;margin-top:8px;font-size:11px;color:var(--muted)}
    .meta .time{opacity:0.95}
    .tick{display:inline-flex;align-items:center;justify-content:center;min-width:18px;margin-left:6px;font-size:12px;line-height:1}
    .tick-sent{color:var(--muted)}
    .tick-delivered{color:var(--delivered)}
    .tick-read{color:var(--read)}

    .input-area{
      position:fixed;left:0;right:0;bottom:0;height:var(--input-height);
      background:rgba(255,255,255,0.98);padding:10px;display:flex;align-items:center;gap:8px;
      border-top:1px solid #e6e6e6;box-shadow:0 -6px 18px rgba(0,0,0,0.04);
    }
    .input-area .fields{display:flex;gap:8px;align-items:center;flex:1}
    input[type="text"], input#chatId{
      height:44px;padding:10px 14px;border-radius:22px;border:1px solid #ddd;outline:none;font-size:15px;background:#fff;width: 100%;
    }
    button{
      background:var(--accent);color:#fff;border:none;padding:10px 16px;border-radius:22px;cursor:pointer;font-weight:700;height:44px;min-width:84px;
      display:inline-flex;align-items:center;justify-content:center;box-shadow:0 3px 8px rgba(7,94,84,0.16);
    }

    @media(max-width:600px){
      .message{max-width:86%}
      .avatar{width:40px;height:40px;font-size:16px}
      input[type="text"],input#chatId{height:40px}
    }
  </style>
</head>
<body>

  <header>
    <div class="avatar">CS</div>
    <div class="header-info">
      <div class="header-title">Customer Service Test</div>
      <div class="header-status" id="presenceStatus">Menunggu status...</div>
    </div>
  </header>

  <div class="chat-container" id="chatContainer">
    <div id="typingStatus"></div>
    <!-- pesan akan ditambahkan di sini -->
  </div>

  <div class="input-area">
    <div class="fields">
      <input id="chatId" type="text" placeholder="Chat ID (628xxx@s.whatsapp.net)" value="6289617349913@s.whatsapp.net" />
      <input id="text" type="text" placeholder="Ketik pesan..." autocomplete="off" />
    </div>
    <button id="sendBtn">Kirim</button>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    // Konfigurasi socket
    const socket = io('http://localhost:3000', {
      path: '/socket.io/',
      transports: ['polling','websocket'],
      reconnection: true,
      timeout: 10000
    });

    // DOM
    const chatContainer = document.getElementById('chatContainer');
    const typingStatus = document.getElementById('typingStatus');
    const presenceStatus = document.getElementById('presenceStatus');
    const textInput = document.getElementById('text');
    const chatIdInput = document.getElementById('chatId');
    const sendBtn = document.getElementById('sendBtn');

    // State lokal untuk deduplikasi & mapping temp->real
    const sentMessages = new Set(); // menyimpan real message ids yang sudah ditampilkan
    const tempToReal = new Map();   // tempId -> realId (jika sudah ack)
    const realToTemp = new Map();   // realId -> tempId (opsional, untuk update bubble)

    // Utility kecil untuk debugging
    function log(...args){ console.debug('[client]', ...args) }

    // Fokus input
    textInput.focus();

    // Enter to send
    textInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); kirimPesan(); }
    });
    sendBtn.addEventListener('click', kirimPesan);

    socket.on('connect', () => {
      presenceStatus.innerHTML = 'Terhubung ke server';
      log('connected', socket.id);
    });
    socket.on('connect_error', (err) => {
      presenceStatus.innerHTML = 'Gagal terhubung: ' + (err?.message || err);
      console.error('connect_error', err);
    });

    // Handler: ACK dari server -> ganti temp bubble jadi real id
    socket.on('messageAck', (data) => {
      log('messageAck', data);
      const { tempId, message } = data || {};
      if (!tempId || !message || !message.id) return;

      const tempBubble = document.querySelector(`[data-id="${tempId}"]`);
      if (tempBubble) {
        // set data-id pada bubble jadi id nyata
        tempBubble.setAttribute('data-id', message.id);

        // update waktu & centang
        const meta = tempBubble.parentElement.querySelector('.meta');
        if (meta) {
          const timeEl = meta.querySelector('.time');
          if (timeEl) timeEl.innerText = new Date(message.timestamp || Date.now()).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'});

          const tickEl = meta.querySelector('.tick');
          if (tickEl) {
            if (message.status === 'delivered'){ tickEl.innerText='✓✓'; tickEl.className='tick tick-delivered' }
            else if (message.status === 'read'){ tickEl.innerText='✓✓'; tickEl.className='tick tick-read' }
            else { tickEl.innerText='✓'; tickEl.className='tick tick-sent' }
          }
        }

        // simpan mapping & id ke set untuk deduplikasi
        tempToReal.set(tempId, message.id);
        realToTemp.set(message.id, tempId);
        sentMessages.add(message.id);
      } else {
        // fallback: kalau tidak ditemukan temp bubble, tambahkan pesan baru
        tambahPesanKeUI(message);
        sentMessages.add(message.id);
      }
    });

    // Handler: pesan baru dari server. Jangan tambah kalau id sudah tampil
    socket.on('newMessage', (msg) => {
      log('newMessage', msg);
      if (!msg || !msg.id) return;

      // Jika pesan ini sudah ada (sudah acked atau sebelumnya ditampilkan), hanya update status
      if (sentMessages.has(msg.id) || Array.from(tempToReal.values()).includes(msg.id)) {
        updateStatusBubble(msg.id, msg.status);
        return;
      }

      tambahPesanKeUI(msg);
      sentMessages.add(msg.id);
      scrollKeBawah();
    });

    // Typing / presence / receipt handlers (opsional)
    socket.on('typing', (data) => {
      typingStatus.innerHTML = data?.isTyping ? 'Sedang mengetik...' : '';
      if (data?.isTyping){
        clearTimeout(window._typingTimeout); window._typingTimeout = setTimeout(()=>{ typingStatus.innerHTML=''; }, 3500);
      }
    });

    socket.on('presence', (data) => {
      let text = data?.isOnline ? 'Online' : 'Offline';
      if (!data?.isOnline && data?.lastSeen) text += ` • Terakhir dilihat: ${new Date(data.lastSeen).toLocaleString('id-ID')}`;
      presenceStatus.innerHTML = text;
    });

    socket.on('receipt', (data) => {
      log('receipt', data);
      if (!data?.messageId) return;
      updateStatusBubble(data.messageId, data.status);
    });

    // Kirim pesan (optimistic UI)
    function kirimPesan(){
      const chatId = chatIdInput.value.trim();
      const text = textInput.value.trim();
      if (!chatId || !text) return alert('Isi chatId dan pesan!');

      const tempId = 'temp-' + Date.now() + '-' + Math.floor(Math.random()*9999);
      // Kirim ke server dengan tempId
      socket.emit('sendMessage', { chatId, text, tempId });
      log('emit sendMessage', { chatId, tempId, text });

      // Tampilkan optimistic bubble
      tambahPesanKeUI({
        id: tempId,
        chatId,
        from: 'agent',
        text,
        status: 'sent',
        timestamp: new Date().toISOString()
      });
      // tandai tempId sebagai "sudah ditampilkan" (tapi bukan real id)
      // tidak dimasukkan ke sentMessages agar dapat diganti saat ack datang
      textInput.value = '';
      textInput.focus();
      scrollKeBawah();
    }

    // Tambah pesan ke UI (dipakai untuk pesan masuk & optimistic)
    function tambahPesanKeUI(msg){
      const isSent = msg.from === 'agent';
      const wrapper = document.createElement('div');
      wrapper.style.display = 'flex';
      wrapper.style.flexDirection = 'column';
      wrapper.style.alignItems = isSent ? 'flex-end' : 'flex-start';

      const bubble = document.createElement('div');
      bubble.className = `message ${isSent ? 'sent' : 'received'}`;
      bubble.setAttribute('data-id', msg.id);

      bubble.innerText = msg.text || '[Pesan lain]';

      const meta = document.createElement('div');
      meta.className = 'meta';
      const time = document.createElement('div');
      time.className = 'time';
      const ts = msg.timestamp ? new Date(msg.timestamp) : new Date();
      time.innerText = ts.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'});
      meta.appendChild(time);

      if (isSent){
        const tick = document.createElement('div');
        tick.className = 'tick tick-sent';
        if (msg.status === 'sent'){ tick.innerText = '✓'; tick.className = 'tick tick-sent' }
        else if (msg.status === 'delivered'){ tick.innerText = '✓✓'; tick.className='tick tick-delivered' }
        else if (msg.status === 'read'){ tick.innerText = '✓✓'; tick.className='tick tick-read' }
        meta.appendChild(tick);
      }

      wrapper.appendChild(bubble);
      wrapper.appendChild(meta);
      chatContainer.appendChild(wrapper);
    }

    // Update centang/status pada bubble (mencari dengan real id atau temp mapping)
    function updateStatusBubble(messageId, status){
      // jika kita punya mapping real->temp, gunakan temp bubble dulu (kemungkinan optimistic)
      const maybeTemp = realToTemp.get(messageId);
      const selectorId = maybeTemp || messageId;
      const bubble = document.querySelector(`[data-id="${selectorId}"]`);
      if (!bubble) {
        // kalau tidak ada bubble yang cocok, coba temukan dengan real id
        const fallback = document.querySelector(`[data-id="${messageId}"]`);
        if (!fallback) return;
        updateMetaForBubble(fallback, status);
        return;
      }
      updateMetaForBubble(bubble, status);
    }

    function updateMetaForBubble(bubble, status){
      const meta = bubble.parentElement.querySelector('.meta');
      if (!meta) return;
      const tickEl = meta.querySelector('.tick');
      if (!tickEl) return;
      if (status === 'delivered'){ tickEl.innerText='✓✓'; tickEl.className='tick tick-delivered' }
      else if (status === 'read'){ tickEl.innerText='✓✓'; tickEl.className='tick tick-read' }
      else { tickEl.innerText='✓'; tickEl.className='tick tick-sent' }
    }

    function scrollKeBawah(){ chatContainer.scrollTop = chatContainer.scrollHeight; }

    // keep view visible on mobile when keyboard opened
    window.addEventListener('resize', ()=>{ setTimeout(scrollKeBawah, 100); });

    // debugging helper: tampilkan event masuk di console
    ['connect','disconnect','reconnect','reconnect_attempt'].forEach(e=>{
      socket.on(e,(...a)=>log('socket event',e,...a));
    });

  </script>
</body>
</html>